<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‹¤ì‹œê°„ ì±„íŒ… ë°ëª¨ - ë‹¹ê·¼ë§ˆì¼“</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f8f9fa;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: #ff6f0f;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 600;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4caf50;
    }

    .status-indicator.disconnected {
      background: #f44336;
    }

    .connection-controls {
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
    }

    .control-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .control-group input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .control-group button {
      padding: 10px 20px;
      background: #ff6f0f;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .control-group button:hover {
      background: #e56000;
    }

    .control-group button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .messages-container {
      height: 400px;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      display: flex;
      gap: 10px;
      max-width: 70%;
    }

    .message.own {
      margin-left: auto;
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #ff6f0f;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      flex-shrink: 0;
    }

    .message-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .message-bubble {
      padding: 10px 14px;
      border-radius: 18px;
      background: #f1f3f5;
      word-wrap: break-word;
    }

    .message.own .message-bubble {
      background: #ff6f0f;
      color: white;
    }

    .message-info {
      font-size: 11px;
      color: #868e96;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .message.own .message-info {
      flex-direction: row-reverse;
    }

    .read-indicator {
      font-size: 11px;
      color: #ff6f0f;
    }

    .typing-indicator {
      padding: 10px 20px;
      color: #868e96;
      font-size: 13px;
      font-style: italic;
    }

    .input-container {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
    }

    .input-container input {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 24px;
      font-size: 14px;
    }

    .input-container input:focus {
      outline: none;
      border-color: #ff6f0f;
    }

    .input-container button {
      padding: 12px 24px;
      background: #ff6f0f;
      color: white;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }

    .input-container button:hover:not(:disabled) {
      background: #e56000;
    }

    .input-container button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .system-message {
      text-align: center;
      color: #868e96;
      font-size: 12px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 12px;
      margin: 8px auto;
      max-width: 300px;
    }

    .info-panel {
      padding: 15px 20px;
      background: #e7f5ff;
      border-bottom: 1px solid #74c0fc;
      font-size: 13px;
      color: #1971c2;
    }

    .api-docs {
      padding: 20px;
      background: #f8f9fa;
      margin-top: 20px;
      border-radius: 12px;
    }

    .api-docs h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #212529;
    }

    .api-docs pre {
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.6;
      border: 1px solid #e0e0e0;
    }

    .api-docs code {
      color: #ff6f0f;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ… ë°ëª¨</h1>
      <div class="status">
        <div class="status-indicator" id="statusIndicator"></div>
        <span id="statusText">ì—°ê²° ëŒ€ê¸°ì¤‘</span>
      </div>
    </div>

    <div class="connection-controls">
      <div class="control-group">
        <input type="number" id="roomIdInput" placeholder="ì±„íŒ…ë°© ID (ì˜ˆ: 1)" value="1">
        <input type="number" id="userIdInput" placeholder="ì‚¬ìš©ì ID (ì˜ˆ: 1)" value="1">
        <button id="connectBtn" onclick="connectToRoom()">ì±„íŒ…ë°© ì…ì¥</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>í‡´ì¥</button>
      </div>
    </div>

    <div class="info-panel" id="infoPanel" style="display: none;">
      <strong>ì±„íŒ…ë°©:</strong> <span id="currentRoom">-</span> |
      <strong>ì‚¬ìš©ì:</strong> <span id="currentUser">-</span>
    </div>

    <div class="messages-container" id="messagesContainer">
      <div class="system-message">ì±„íŒ…ë°©ì— ì…ì¥í•˜ì—¬ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</div>
    </div>

    <div class="typing-indicator" id="typingIndicator" style="display: none;">
      ìƒëŒ€ë°©ì´ ì…ë ¥ì¤‘ì…ë‹ˆë‹¤...
    </div>

    <div class="input-container">
      <input
        type="text"
        id="messageInput"
        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
        disabled
        onkeypress="handleKeyPress(event)"
        oninput="handleTyping()"
      >
      <button id="sendBtn" onclick="sendMessage()" disabled>ì „ì†¡</button>
    </div>
  </div>

  <div class="container api-docs" style="margin-top: 20px;">
    <h2>ğŸ“š WebSocket API ì‚¬ìš© ê°€ì´ë“œ</h2>

    <h3 style="margin-top: 20px; font-size: 16px;">ì—°ê²°</h3>
    <pre><code>const ws = new WebSocket('ws://localhost:5000');

// ì±„íŒ…ë°© ì…ì¥
ws.send(JSON.stringify({
  type: 'join_room',
  room_id: 1,
  user_id: 1
}));</code></pre>

    <h3 style="margin-top: 20px; font-size: 16px;">ë©”ì‹œì§€ ì „ì†¡</h3>
    <pre><code>ws.send(JSON.stringify({
  type: 'send_message',
  content: 'ì•ˆë…•í•˜ì„¸ìš”!',
  message_type: 'text'  // 'text', 'image', 'deleted'
}));</code></pre>

    <h3 style="margin-top: 20px; font-size: 16px;">ì½ìŒ í‘œì‹œ</h3>
    <pre><code>ws.send(JSON.stringify({
  type: 'mark_read'
}));</code></pre>

    <h3 style="margin-top: 20px; font-size: 16px;">íƒ€ì´í•‘ í‘œì‹œ</h3>
    <pre><code>ws.send(JSON.stringify({
  type: 'typing',
  is_typing: true
}));</code></pre>

    <h3 style="margin-top: 20px; font-size: 16px;">REST API ì—”ë“œí¬ì¸íŠ¸</h3>
    <pre><code>// ì±„íŒ…ë°© ìƒì„±
POST /api/chat/rooms
{ user1_id, user2_id, product_id }

// ì±„íŒ…ë°© ëª©ë¡
GET /api/chat/rooms/user/:user_id

// ë©”ì‹œì§€ ì¡°íšŒ
GET /api/chat/rooms/:room_id/messages?page=1&limit=50

// ë©”ì‹œì§€ ì „ì†¡ (REST)
POST /api/chat/messages
{ room_id, sender_id, content, message_type }

// ì½ìŒ ì²˜ë¦¬
PATCH /api/chat/messages/read
{ room_id, user_id }

// ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜
GET /api/chat/messages/unread/:user_id</code></pre>
  </div>

  <script>
    let ws = null;
    let currentRoomId = null;
    let currentUserId = null;
    let typingTimeout = null;

    function connectToRoom() {
      const roomId = document.getElementById('roomIdInput').value;
      const userId = document.getElementById('userIdInput').value;

      if (!roomId || !userId) {
        alert('ì±„íŒ…ë°© IDì™€ ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      currentRoomId = parseInt(roomId);
      currentUserId = parseInt(userId);

      // WebSocket ì—°ê²°
      ws = new WebSocket('ws://localhost:5000');

      ws.onopen = () => {
        updateStatus('connected', 'ì—°ê²°ë¨');

        // ì±„íŒ…ë°© ì…ì¥
        ws.send(JSON.stringify({
          type: 'join_room',
          room_id: currentRoomId,
          user_id: currentUserId
        }));

        document.getElementById('connectBtn').disabled = true;
        document.getElementById('disconnectBtn').disabled = false;
        document.getElementById('messageInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;

        document.getElementById('infoPanel').style.display = 'block';
        document.getElementById('currentRoom').textContent = currentRoomId;
        document.getElementById('currentUser').textContent = currentUserId;

        // ê¸°ì¡´ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
        loadMessages();
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
      };

      ws.onclose = () => {
        updateStatus('disconnected', 'ì—°ê²° ëŠê¹€');
        document.getElementById('connectBtn').disabled = false;
        document.getElementById('disconnectBtn').disabled = true;
        document.getElementById('messageInput').disabled = true;
        document.getElementById('sendBtn').disabled = true;
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        updateStatus('disconnected', 'ì—°ê²° ì˜¤ë¥˜');
      };
    }

    function disconnect() {
      if (ws) {
        ws.send(JSON.stringify({ type: 'leave_room' }));
        ws.close();
        ws = null;
      }
      document.getElementById('infoPanel').style.display = 'none';
      clearMessages();
      addSystemMessage('ì±„íŒ…ë°©ì—ì„œ í‡´ì¥í–ˆìŠµë‹ˆë‹¤');
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const content = input.value.trim();

      if (!content || !ws) return;

      ws.send(JSON.stringify({
        type: 'send_message',
        content: content,
        message_type: 'text'
      }));

      input.value = '';
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    function handleTyping() {
      if (!ws) return;

      // Send typing indicator
      ws.send(JSON.stringify({
        type: 'typing',
        is_typing: true
      }));

      // Clear previous timeout
      if (typingTimeout) {
        clearTimeout(typingTimeout);
      }

      // Stop typing after 2 seconds
      typingTimeout = setTimeout(() => {
        ws.send(JSON.stringify({
          type: 'typing',
          is_typing: false
        }));
      }, 2000);
    }

    function handleWebSocketMessage(data) {
      switch (data.type) {
        case 'joined':
          addSystemMessage(`ì±„íŒ…ë°© ${data.room_id}ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤`);
          break;

        case 'new_message':
          addMessage(data.data);
          scrollToBottom();

          // Auto mark as read if message is from other user
          if (data.data.sender_id !== currentUserId) {
            markAsRead();
          }
          break;

        case 'typing':
          if (data.user_id !== currentUserId) {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = data.is_typing ? 'block' : 'none';
          }
          break;

        case 'messages_read':
          if (data.data.user_id !== currentUserId) {
            updateReadStatus(data.data.message_ids);
          }
          break;

        case 'error':
          console.error('WebSocket error:', data.message);
          addSystemMessage(`ì˜¤ë¥˜: ${data.message}`);
          break;
      }
    }

    function addMessage(message) {
      const container = document.getElementById('messagesContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${message.sender_id === currentUserId ? 'own' : ''}`;
      messageDiv.dataset.messageId = message.id;

      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = message.sender_id;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.textContent = message.content;

      const info = document.createElement('div');
      info.className = 'message-info';

      const time = new Date(message.created_at).toLocaleTimeString('ko-KR', {
        hour: '2-digit',
        minute: '2-digit'
      });
      info.innerHTML = `<span>${time}</span>`;

      if (message.sender_id === currentUserId && message.is_read) {
        info.innerHTML += '<span class="read-indicator">ì½ìŒ</span>';
      }

      contentDiv.appendChild(bubble);
      contentDiv.appendChild(info);

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(contentDiv);

      container.appendChild(messageDiv);
    }

    function addSystemMessage(text) {
      const container = document.getElementById('messagesContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'system-message';
      messageDiv.textContent = text;
      container.appendChild(messageDiv);
    }

    function clearMessages() {
      document.getElementById('messagesContainer').innerHTML =
        '<div class="system-message">ì±„íŒ…ë°©ì— ì…ì¥í•˜ì—¬ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</div>';
    }

    function updateStatus(status, text) {
      const indicator = document.getElementById('statusIndicator');
      const statusText = document.getElementById('statusText');

      if (status === 'connected') {
        indicator.classList.remove('disconnected');
      } else {
        indicator.classList.add('disconnected');
      }

      statusText.textContent = text;
    }

    function scrollToBottom() {
      const container = document.getElementById('messagesContainer');
      container.scrollTop = container.scrollHeight;
    }

    function markAsRead() {
      if (!ws) return;

      ws.send(JSON.stringify({
        type: 'mark_read'
      }));
    }

    function updateReadStatus(messageIds) {
      messageIds.forEach(id => {
        const messageDiv = document.querySelector(`[data-message-id="${id}"]`);
        if (messageDiv && messageDiv.classList.contains('own')) {
          const info = messageDiv.querySelector('.message-info');
          if (!info.querySelector('.read-indicator')) {
            const readSpan = document.createElement('span');
            readSpan.className = 'read-indicator';
            readSpan.textContent = 'ì½ìŒ';
            info.appendChild(readSpan);
          }
        }
      });
    }

    async function loadMessages() {
      try {
        const response = await fetch(`http://localhost:5000/api/chat/rooms/${currentRoomId}/messages?limit=50`);
        const result = await response.json();

        if (result.success && result.data.length > 0) {
          clearMessages();
          result.data.forEach(message => addMessage(message));
          scrollToBottom();
        }
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }
  </script>
</body>
</html>
