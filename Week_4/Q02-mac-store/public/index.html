<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Shop Apple Mac products - MacBook Air, MacBook Pro, iMac, Mac mini, and more">
  <title>Mac Store - Apple Shopping</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="alternate icon" href="/favicon.svg">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <!-- Toss Payments v1 SDK (API individual key) -->
  <script src="https://js.tosspayments.com/v1/payment"></script>

  <style>
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
    }

    /* Custom animations */
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
      }
      to {
        transform: translateX(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .cart-sidebar-enter {
      animation: slideInRight 0.3s ease-out;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    /* Hero entrance animations */
    @keyframes heroRise {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes heroExpand {
      from {
        opacity: 0;
        letter-spacing: 0.3em;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        letter-spacing: 0.05em;
        transform: translateY(0);
      }
    }

    .hero-title {
      opacity: 0;
      animation: heroRise 1s cubic-bezier(0.16, 1, 0.3, 1) 0.2s forwards;
    }

    .hero-subtitle {
      opacity: 0;
      animation: heroExpand 1s cubic-bezier(0.16, 1, 0.3, 1) 0.7s forwards;
    }

    /* Loading spinner */
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #000;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Hide scrollbar for horizontal scroll */
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, createContext, useContext, useRef } = React;

    // ===========================================
    // CONFIGURATION
    // ===========================================

    // Firebase config
    // NOTE: For production, use a build system to inject these from environment variables
    // This is a development setup with hardcoded values
    const firebaseConfig = {
      apiKey: "AIzaSyA7VaFnJ_qveXoChjNlf9P5Ocbkj14v7M8",
      authDomain: "online-apple-store-9700c.firebaseapp.com",
      projectId: "online-apple-store-9700c"
    };

    // Initialize Firebase (will be configured when user adds credentials)
    let firebaseInitialized = false;
    try {
      if (firebaseConfig.apiKey !== "YOUR_FIREBASE_API_KEY") {
        firebase.initializeApp(firebaseConfig);
        firebaseInitialized = true;
      }
    } catch (error) {
      console.warn('Firebase not configured yet:', error.message);
    }

    // API base URL
    const API_BASE = window.location.origin;

    // Toss Payments config
    const TOSS_CLIENT_KEY = 'test_ck_Ba5PzR0ArnyZp7qoGwXzVvmYnNeD';

    // ===========================================
    // UTILITY FUNCTIONS
    // ===========================================

    // Global error handler for API calls
    const handleApiError = (error, context) => {
      console.error(`[${context}]`, error);

      if (error.response) {
        const { status, data } = error.response;

        switch (status) {
          case 401:
            if (window.showToast) {
              window.showToast('Session expired. Please sign in again.', 'error');
            }
            // Could trigger logout here
            break;
          case 404:
            if (window.showToast) {
              window.showToast(data.error || 'Resource not found', 'error');
            }
            break;
          case 400:
            if (window.showToast) {
              window.showToast(data.error || 'Invalid request', 'error');
            }
            break;
          case 500:
            if (window.showToast) {
              window.showToast('Server error. Please try again later.', 'error');
            }
            break;
          default:
            if (window.showToast) {
              window.showToast('An error occurred', 'error');
            }
        }
      } else if (error.request) {
        if (window.showToast) {
          window.showToast('Connection lost. Please check your internet.', 'error');
        }
      } else {
        if (window.showToast) {
          window.showToast(error.message || 'An unexpected error occurred', 'error');
        }
      }
    };

    // ===========================================
    // CONTEXTS
    // ===========================================

    // Auth Context
    const AuthContext = createContext(null);

    function AuthProvider({ children }) {
      const [user, setUser] = useState(() => {
        try {
          const saved = localStorage.getItem('userData');
          return saved ? JSON.parse(saved) : null;
        } catch { return null; }
      });
      const [jwtToken, setJwtToken] = useState(localStorage.getItem('jwtToken'));
      const [isLoading, setIsLoading] = useState(true);
      const [onLoginCallback, setOnLoginCallback] = useState(null);
      const [onLogoutCallback, setOnLogoutCallback] = useState(null);

      useEffect(() => {
        if (jwtToken) {
          // Verify token and refresh user profile from server
          fetch(`${API_BASE}/api/auth/verify`, {
            headers: { Authorization: `Bearer ${jwtToken}` }
          })
            .then(res => {
              if (!res.ok) throw new Error('Token invalid');
              return res.json();
            })
            .then(data => {
              setUser(data.user);
              localStorage.setItem('userData', JSON.stringify(data.user));
            })
            .catch(() => {
              // Token expired or invalid — clear auth state
              setUser(null);
              setJwtToken(null);
              localStorage.removeItem('jwtToken');
              localStorage.removeItem('userData');
            })
            .finally(() => setIsLoading(false));
        } else {
          setIsLoading(false);
        }
      }, []);

      const signInWithGoogle = async () => {
        if (!firebaseInitialized) {
          alert('Firebase not configured. Please add your Firebase credentials to index.html');
          return;
        }

        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          const result = await firebase.auth().signInWithPopup(provider);
          const idToken = await result.user.getIdToken();

          // Send to backend for verification
          const response = await fetch(`${API_BASE}/api/auth/firebase`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idToken })
          });

          if (!response.ok) {
            throw new Error('Authentication failed');
          }

          const data = await response.json();
          setJwtToken(data.token);
          setUser(data.user);
          localStorage.setItem('jwtToken', data.token);
          localStorage.setItem('userData', JSON.stringify(data.user));

          // Trigger callback if set (for cart sync)
          if (onLoginCallback) {
            onLoginCallback();
          }

          return data;
        } catch (error) {
          console.error('Sign in error:', error);
          throw error;
        }
      };

      const signOut = async () => {
        if (firebaseInitialized) {
          await firebase.auth().signOut();
        }

        // Clear cart on logout
        if (onLogoutCallback) {
          onLogoutCallback();
        }

        setUser(null);
        setJwtToken(null);
        localStorage.removeItem('jwtToken');
        localStorage.removeItem('userData');
      };

      const getAuthHeaders = () => {
        return jwtToken ? { Authorization: `Bearer ${jwtToken}` } : {};
      };

      return (
        <AuthContext.Provider value={{
          user,
          jwtToken,
          isLoading,
          isAuthenticated: !!jwtToken,
          signInWithGoogle,
          signOut,
          getAuthHeaders,
          setOnLoginCallback,
          setOnLogoutCallback
        }}>
          {children}
        </AuthContext.Provider>
      );
    }

    // Cart Context
    const CartContext = createContext(null);

    function CartProvider({ children }) {
      const [items, setItems] = useState([]);
      const [isOpen, setIsOpen] = useState(false);
      const [showLoginPrompt, setShowLoginPrompt] = useState(false);
      const { getAuthHeaders, isAuthenticated, setOnLoginCallback, setOnLogoutCallback } = useContext(AuthContext);

      // Set login callback to sync cart
      useEffect(() => {
        if (setOnLoginCallback) {
          setOnLoginCallback(() => syncCart);
        }
      }, [setOnLoginCallback]);

      // Set logout callback to clear cart
      useEffect(() => {
        if (setOnLogoutCallback) {
          setOnLogoutCallback(() => clearCart);
        }
      }, [setOnLogoutCallback]);

      // Calculate totals
      const subtotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const tax = subtotal * 0.1; // 10% tax
      const total = subtotal + tax;

      // Load cart when user logs in
      useEffect(() => {
        if (isAuthenticated) {
          syncCart();
        } else {
          // Clear cart when not authenticated
          setItems([]);
        }
      }, [isAuthenticated]);

      const addToCart = async (product, quantity = 1, config = {}) => {
        // REQUIRE LOGIN: Check authentication first
        if (!isAuthenticated) {
          // Show login prompt instead of adding to cart
          setShowLoginPrompt(true);
          if (window.showToast) {
            window.showToast('Please sign in to add items to cart', 'error');
          }
          return false; // Return false to indicate failure
        }

        // User is authenticated - call backend API
        try {
          const response = await fetch(`${API_BASE}/api/cart/add`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...getAuthHeaders()
            },
            body: JSON.stringify({
              productId: product.id,
              quantity,
              config
            })
          });

          if (!response.ok) {
            throw new Error('Failed to add to cart');
          }

          const data = await response.json();
          if (data.success && data.cart) {
            // Update cart from server response
            setItems(data.cart.items);
          }

          setIsOpen(true);
          return true; // Return true to indicate success
        } catch (error) {
          console.error('Error adding to cart:', error);
          if (window.showToast) {
            window.showToast('Failed to add item to cart. Please try again.', 'error');
          }
          return false; // Return false to indicate failure
        }
      };

      const updateQuantity = async (itemId, quantity) => {
        if (quantity < 1) return;
        if (!isAuthenticated) return; // Must be logged in

        // Call backend API for authenticated users
        try {
          const response = await fetch(`${API_BASE}/api/cart/update/${itemId}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              ...getAuthHeaders()
            },
            body: JSON.stringify({ quantity })
          });

          if (!response.ok) {
            throw new Error('Failed to update quantity');
          }

          const data = await response.json();
          if (data.success) {
            // Update local state
            setItems(prev =>
              prev.map(item =>
                item.id === itemId ? { ...item, quantity } : item
              )
            );
          }
        } catch (error) {
          console.error('Error updating quantity:', error);
          if (window.showToast) {
            window.showToast('Failed to update quantity. Please try again.', 'error');
          }
        }
      };

      const removeItem = async (itemId) => {
        if (!isAuthenticated) return; // Must be logged in

        // Call backend API for authenticated users
        try {
          const response = await fetch(`${API_BASE}/api/cart/remove/${itemId}`, {
            method: 'DELETE',
            headers: getAuthHeaders()
          });

          if (!response.ok) {
            throw new Error('Failed to remove item');
          }

          const data = await response.json();
          if (data.success) {
            setItems(prev => prev.filter(item => item.id !== itemId));
          }
        } catch (error) {
          console.error('Error removing item:', error);
          if (window.showToast) {
            window.showToast('Failed to remove item. Please try again.', 'error');
          }
        }
      };

      const syncCart = async () => {
        if (!isAuthenticated) return;

        try {
          // Fetch server cart
          const response = await fetch(`${API_BASE}/api/cart`, {
            headers: getAuthHeaders()
          });

          if (!response.ok) {
            throw new Error('Failed to fetch cart');
          }

          const serverCart = await response.json();
          setItems(serverCart.items || []);
        } catch (error) {
          console.error('Error syncing cart:', error);
        }
      };

      const clearCart = () => {
        setItems([]);
      };

      return (
        <CartContext.Provider value={{
          items,
          subtotal,
          tax,
          total,
          isOpen,
          setIsOpen,
          addToCart,
          updateQuantity,
          removeItem,
          clearCart,
          syncCart,
          showLoginPrompt,
          setShowLoginPrompt
        }}>
          {children}
        </CartContext.Provider>
      );
    }

    // ===========================================
    // COMPONENTS
    // ===========================================

    // Navigation
    function Navigation() {
      const { isAuthenticated, user, signOut } = useContext(AuthContext);
      const { items, setIsOpen, showLoginPrompt, setShowLoginPrompt } = useContext(CartContext);
      const [showLoginModal, setShowLoginModal] = useState(false);
      const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

      const cartCount = items.reduce((sum, item) => sum + item.quantity, 0);

      // Handle login prompt from cart
      useEffect(() => {
        if (showLoginPrompt) {
          setShowLoginModal(true);
          setShowLoginPrompt(false); // Reset the prompt
        }
      }, [showLoginPrompt, setShowLoginPrompt]);

      return (
        <>
          <nav className="bg-white border-b border-gray-200 sticky top-0 z-50 backdrop-blur-md bg-opacity-90">
            <div className="max-w-7xl mx-auto px-6 py-4">
              <div className="flex justify-between items-center">
                <div
                  className="text-2xl font-bold cursor-pointer"
                  onClick={() => window.location.hash = '#/'}
                >
                  Mac Store
                </div>

                {/* Desktop Menu */}
                <div className="hidden md:flex gap-8 items-center">
                  <a href="#/" className="font-semibold hover:text-gray-600 transition-colors">
                    Products
                  </a>

                  <button
                    onClick={() => setIsOpen(true)}
                    className="relative p-2 hover:bg-gray-100 rounded-lg transition-all"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    {cartCount > 0 && (
                      <span className="absolute -top-1 -right-1 bg-black text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
                        {cartCount}
                      </span>
                    )}
                  </button>

                  {isAuthenticated ? (
                    <div className="flex items-center gap-4">
                      <button
                        onClick={() => window.location.hash = '#/orders'}
                        className="flex items-center gap-2 hover:opacity-70 transition-opacity"
                        title="Order History"
                      >
                        {user?.photo_url && (
                          <img src={user.photo_url} alt={user.name} className="w-8 h-8 rounded-full" />
                        )}
                        <span className="text-sm font-semibold">{user?.name || 'My Orders'}</span>
                      </button>
                      <button
                        onClick={signOut}
                        className="text-sm font-semibold hover:text-gray-600"
                      >
                        Sign Out
                      </button>
                    </div>
                  ) : (
                    <button
                      onClick={() => setShowLoginModal(true)}
                      className="bg-black text-white px-6 py-2 rounded-lg font-semibold hover:bg-gray-800 transition-all"
                    >
                      Sign In
                    </button>
                  )}
                </div>

                {/* Mobile Menu Button */}
                <div className="md:hidden flex items-center gap-4">
                  <button
                    onClick={() => setIsOpen(true)}
                    className="relative p-2 hover:bg-gray-100 rounded-lg transition-all"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    {cartCount > 0 && (
                      <span className="absolute -top-1 -right-1 bg-black text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
                        {cartCount}
                      </span>
                    )}
                  </button>
                  <button
                    onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
                    className="p-2 hover:bg-gray-100 rounded-lg"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      {isMobileMenuOpen ? (
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      ) : (
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                      )}
                    </svg>
                  </button>
                </div>
              </div>

              {/* Mobile Menu */}
              {isMobileMenuOpen && (
                <div className="md:hidden mt-4 pb-4 space-y-3">
                  <a
                    href="#/"
                    className="block font-semibold hover:text-gray-600 py-2"
                    onClick={() => setIsMobileMenuOpen(false)}
                  >
                    Products
                  </a>
                  {isAuthenticated ? (
                    <>
                      <button
                        onClick={() => {
                          window.location.hash = '#/orders';
                          setIsMobileMenuOpen(false);
                        }}
                        className="flex items-center gap-3 py-2 w-full hover:opacity-70"
                      >
                        {user?.photo_url && (
                          <img src={user.photo_url} alt={user.name} className="w-8 h-8 rounded-full" />
                        )}
                        <span className="font-semibold">{user?.name || 'My Orders'}</span>
                      </button>
                      <a
                        href="#/orders"
                        className="block font-semibold hover:text-gray-600 py-2"
                        onClick={() => setIsMobileMenuOpen(false)}
                      >
                        Order History
                      </a>
                      <button
                        onClick={() => {
                          signOut();
                          setIsMobileMenuOpen(false);
                        }}
                        className="block w-full text-left font-semibold hover:text-gray-600 py-2"
                      >
                        Sign Out
                      </button>
                    </>
                  ) : (
                    <button
                      onClick={() => {
                        setShowLoginModal(true);
                        setIsMobileMenuOpen(false);
                      }}
                      className="block w-full bg-black text-white px-6 py-2 rounded-lg font-semibold hover:bg-gray-800"
                    >
                      Sign In
                    </button>
                  )}
                </div>
              )}
            </div>
          </nav>

          {showLoginModal && (
            <LoginModal onClose={() => setShowLoginModal(false)} />
          )}
        </>
      );
    }

    // Login Modal
    function LoginModal({ onClose }) {
      const { signInWithGoogle } = useContext(AuthContext);
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState(null);

      const handleGoogleSignIn = async () => {
        setIsLoading(true);
        setError(null);
        try {
          await signInWithGoogle();
          onClose();
        } catch (err) {
          setError(err.message);
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
          <div className="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold">Sign In</h2>
              <button
                onClick={onClose}
                className="text-gray-500 hover:text-black"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            {error && (
              <div className="bg-red-50 text-red-600 p-4 rounded-lg mb-4">
                {error}
              </div>
            )}

            <button
              onClick={handleGoogleSignIn}
              disabled={isLoading}
              className="w-full bg-white border-2 border-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-50 transition-all flex items-center justify-center gap-3 disabled:opacity-50"
            >
              {isLoading ? (
                <div className="spinner"></div>
              ) : (
                <>
                  <svg className="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                  </svg>
                  Continue with Google
                </>
              )}
            </button>

            <p className="text-sm text-gray-500 text-center mt-4">
              Sign in to save your cart and access order history
            </p>
          </div>
        </div>
      );
    }

    // Cart Sidebar
    function CartSidebar() {
      const { items, subtotal, tax, total, isOpen, setIsOpen, updateQuantity, removeItem } = useContext(CartContext);

      if (!isOpen) return null;

      return (
        <>
          <div
            className="fixed inset-0 bg-black bg-opacity-50 z-40"
            onClick={() => setIsOpen(false)}
          ></div>

          <div className="fixed right-0 top-0 h-full w-full max-w-md bg-white shadow-2xl z-50 overflow-y-auto cart-sidebar-enter">
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold">Shopping Cart</h2>
                <button
                  onClick={() => setIsOpen(false)}
                  className="text-gray-500 hover:text-black"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              {items.length === 0 ? (
                <div className="text-center py-12">
                  <svg className="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  <p className="text-gray-500 text-lg">Your cart is empty</p>
                </div>
              ) : (
                <>
                  <div className="space-y-4 mb-6">
                    {items.map(item => (
                      <div key={item.id} className="flex gap-4 bg-gray-50 rounded-xl p-4">
                        <div className="w-20 h-20 bg-white rounded-lg flex items-center justify-center overflow-hidden">
                          <img
                            src={item.image_url}
                            alt={item.name}
                            className="w-full h-full object-contain"
                            onError={(e) => {
                              e.target.onerror = null;
                              e.target.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="%23ccc" stroke-width="1"><path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>';
                            }}
                          />
                        </div>

                        <div className="flex-1">
                          <h3 className="font-semibold">{item.name}</h3>
                          <p className="text-sm text-gray-600">
                            ${item.price.toLocaleString()}
                          </p>

                          <div className="flex items-center gap-3 mt-2">
                            <button
                              onClick={() => updateQuantity(item.id, item.quantity - 1)}
                              className="w-8 h-8 rounded-full border border-gray-300 hover:bg-gray-100 flex items-center justify-center"
                            >
                              −
                            </button>
                            <span className="font-semibold">{item.quantity}</span>
                            <button
                              onClick={() => updateQuantity(item.id, item.quantity + 1)}
                              className="w-8 h-8 rounded-full border border-gray-300 hover:bg-gray-100 flex items-center justify-center"
                            >
                              +
                            </button>

                            <button
                              onClick={() => removeItem(item.id)}
                              className="ml-auto text-sm text-red-600 hover:text-red-800"
                            >
                              Remove
                            </button>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>

                  <div className="border-t border-gray-200 pt-4 space-y-2">
                    <div className="flex justify-between text-sm">
                      <span>Subtotal</span>
                      <span>${subtotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                    <div className="flex justify-between text-sm">
                      <span>Tax (10%)</span>
                      <span>${tax.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                    <div className="flex justify-between text-xl font-bold pt-2 border-t border-gray-200">
                      <span>Total</span>
                      <span>${total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                  </div>

                  <div className="mt-6 space-y-3">
                    <button
                      onClick={() => setIsOpen(false)}
                      className="w-full bg-white text-black border-2 border-black px-6 py-3 rounded-full font-semibold hover:bg-gray-50 transition-all"
                    >
                      Continue Shopping
                    </button>
                    <button
                      onClick={() => {
                        setIsOpen(false);
                        window.location.hash = '#/checkout';
                      }}
                      className="w-full bg-black text-white px-9 py-5 rounded-full text-lg font-semibold hover:bg-gray-800 transition-all"
                    >
                      Proceed to Checkout →
                    </button>
                  </div>
                </>
              )}
            </div>
          </div>
        </>
      );
    }

    // Toast Notification Component
    function ToastContainer() {
      const [toasts, setToasts] = useState([]);

      // Expose addToast globally
      useEffect(() => {
        window.showToast = (message, type = 'success') => {
          const id = Date.now();
          setToasts(prev => [...prev, { id, message, type }]);
          setTimeout(() => {
            setToasts(prev => prev.filter(t => t.id !== id));
          }, 3000);
        };
      }, []);

      return (
        <div className="fixed bottom-4 right-4 z-50 space-y-2">
          {toasts.map(toast => (
            <div
              key={toast.id}
              className={`px-6 py-3 rounded-lg shadow-lg fade-in ${
                toast.type === 'success'
                  ? 'bg-black text-white border border-gray-800'
                  : 'bg-white text-black border-2 border-red-500'
              }`}
            >
              {toast.message}
            </div>
          ))}
        </div>
      );
    }

    // Category Filter Component
    function CategoryFilter({ selectedCategory, onCategoryChange }) {
      const categories = [
        { id: 'all', name: 'All' },
        { id: 'macbook-air', name: 'MacBook Air' },
        { id: 'macbook-pro', name: 'MacBook Pro' },
        { id: 'imac', name: 'iMac' },
        { id: 'mac-mini', name: 'Mac mini' }
      ];

      return (
        <div className="flex gap-3 overflow-x-auto pb-4">
          {categories.map(cat => (
            <button
              key={cat.id}
              onClick={() => onCategoryChange(cat.id)}
              className={`px-6 py-2 rounded-full font-semibold transition-all whitespace-nowrap ${
                selectedCategory === cat.id
                  ? 'bg-black text-white'
                  : 'bg-white text-gray-700 border-2 border-gray-200 hover:border-black'
              }`}
            >
              {cat.name}
            </button>
          ))}
        </div>
      );
    }

    // Home Page
    function HomePage() {
      const { addToCart } = useContext(CartContext);
      const [products, setProducts] = useState([]);
      const [isLoading, setIsLoading] = useState(true);

      useEffect(() => {
        // Fetch all products from API
        fetch(`${API_BASE}/api/products`)
          .then(res => res.json())
          .then(data => {
            setProducts(data.products || []);
            setIsLoading(false);
          })
          .catch(error => {
            console.error('Error fetching products:', error);
            setIsLoading(false);
          });
      }, []);

      const handleAddToCart = async (product) => {
        const success = await addToCart(product, 1, {});
        // Only show success toast if item was actually added
        if (success && window.showToast) {
          window.showToast(`${product.name} added to cart!`, 'success');
        }
      };

      const handleProductClick = (productId) => {
        window.location.hash = `#/product/${productId}`;
      };

      // Group products by category
      const groupedProducts = products.reduce((acc, product) => {
        const category = product.category || 'Other';
        if (!acc[category]) {
          acc[category] = [];
        }
        acc[category].push(product);
        return acc;
      }, {});

      // Category display names
      const categoryNames = {
        'macbook-air': 'MacBook Air',
        'macbook-pro': 'MacBook Pro',
        'imac': 'iMac',
        'mac-mini': 'Mac mini',
        'mac-studio': 'Mac Studio',
        'mac-pro': 'Mac Pro'
      };

      return (
        <div>
          {/* Hero Section */}
          <div className="bg-gradient-to-b from-white to-gray-50 py-20 overflow-hidden">
            <div className="max-w-7xl mx-auto px-6 text-center">
              <h1 className="hero-title text-4xl md:text-6xl font-bold mb-4">
                Explore the Mac Universe
              </h1>
              <p className="hero-subtitle text-xl text-gray-600 tracking-wide">
                Bold. Powerful. Elegant.
              </p>
            </div>
          </div>

          {/* Products by Category */}
          <div className="max-w-7xl mx-auto px-6 py-12">
            {isLoading ? (
              <div className="flex justify-center py-20">
                <div className="spinner"></div>
              </div>
            ) : products.length === 0 ? (
              <div className="text-center py-20">
                <p className="text-xl text-gray-600">
                  No products available yet. Please add products to the database.
                </p>
              </div>
            ) : (
              <div className="space-y-16">
                {Object.entries(groupedProducts).map(([category, categoryProducts]) => (
                  <div key={category}>
                    {/* Category Header */}
                    <h2 className="text-3xl font-bold mb-6">
                      {categoryNames[category] || category}
                    </h2>

                    {/* Horizontal Scrolling Product List */}
                    <div className="relative">
                      <div className="flex gap-6 overflow-x-auto pb-4 scrollbar-hide snap-x snap-mandatory">
                        {categoryProducts.map(product => (
                          <div
                            key={product.id}
                            className="flex-shrink-0 w-80 bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden hover:-translate-y-1 cursor-pointer border border-gray-200 snap-start"
                            onClick={() => handleProductClick(product.id)}
                          >
                            <div className="w-full h-64 bg-white flex items-center justify-center overflow-hidden">
                              <img
                                src={product.image_url}
                                alt={product.name}
                                className="w-full h-full object-contain"
                                onError={(e) => {
                                  e.target.onerror = null;
                                  e.target.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 24 24" fill="none" stroke="%23ccc" stroke-width="1"><path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>';
                                }}
                              />
                            </div>

                            <div className="p-6">
                              <h3 className="text-2xl font-bold mb-2">{product.name}</h3>
                              <p className="text-gray-600 mb-4 line-clamp-2">{product.description}</p>
                              <p className="text-3xl font-bold mb-4">
                                ${product.price.toLocaleString()}
                              </p>

                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleAddToCart(product);
                                }}
                                className="w-full bg-black text-white px-6 py-3 rounded-full font-semibold hover:bg-gray-800 transition-all"
                              >
                                Add to Cart
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    // Product Detail Page
    function ProductDetailPage({ productId }) {
      const { addToCart } = useContext(CartContext);
      const [product, setProduct] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [selectedConfig, setSelectedConfig] = useState({ storage: '', memory: '' });
      const [currentImageIndex, setCurrentImageIndex] = useState(0);

      useEffect(() => {
        // Fetch product details
        fetch(`${API_BASE}/api/products/${productId}`)
          .then(res => res.json())
          .then(data => {
            setProduct(data.product);
            // Set default config
            if (data.product?.specs) {
              setSelectedConfig({
                storage: data.product.specs.storage || '',
                memory: data.product.specs.memory || ''
              });
            }
            setIsLoading(false);
          })
          .catch(error => {
            console.error('Error fetching product:', error);
            setIsLoading(false);
          });
      }, [productId]);

      // Calculate price based on configuration
      const calculatePrice = () => {
        if (!product) return 0;

        // Convert price string to number
        let basePrice = parseFloat(product.price);
        let configPrice = basePrice;

        // Storage pricing (base is 256GB)
        const storagePricing = {
          '256GB SSD': 0,      // Base price
          '512GB SSD': 200,    // +$200
          '1TB SSD': 400,      // +$400
          '2TB SSD': 800       // +$800
        };

        // Memory pricing (base is 8GB)
        const memoryPricing = {
          '8GB': 0,            // Base price
          '16GB': 200,         // +$200
          '32GB': 400,         // +$400
          '64GB': 800          // +$800
        };

        // Get base storage and memory from product specs
        const baseStorage = product.specs?.storage || '256GB SSD';
        const baseMemory = product.specs?.memory || '8GB';

        // Calculate storage upgrade cost
        const baseStorageCost = storagePricing[baseStorage] || 0;
        const selectedStorageCost = storagePricing[selectedConfig.storage] || 0;
        const storageUpgrade = selectedStorageCost - baseStorageCost;

        // Calculate memory upgrade cost
        const baseMemoryCost = memoryPricing[baseMemory] || 0;
        const selectedMemoryCost = memoryPricing[selectedConfig.memory] || 0;
        const memoryUpgrade = selectedMemoryCost - baseMemoryCost;

        // Total price = base price + upgrades
        configPrice = basePrice + storageUpgrade + memoryUpgrade;

        return configPrice;
      };

      const currentPrice = calculatePrice();

      const handleAddToCart = async () => {
        if (product) {
          // Create product object with updated price
          const productWithConfig = {
            ...product,
            price: currentPrice
          };
          const success = await addToCart(productWithConfig, 1, selectedConfig);
          // Only show success toast if item was actually added
          if (success && window.showToast) {
            window.showToast(`${product.name} added to cart!`, 'success');
          }
        }
      };

      if (isLoading) {
        return (
          <div className="flex justify-center py-20">
            <div className="spinner"></div>
          </div>
        );
      }

      if (!product) {
        return (
          <div className="max-w-7xl mx-auto px-6 py-20 text-center">
            <h2 className="text-3xl font-bold mb-4">Product Not Found</h2>
            <button
              onClick={() => window.location.hash = '#/'}
              className="bg-black text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-800"
            >
              Back to Products
            </button>
          </div>
        );
      }

      const storageOptions = ['256GB SSD', '512GB SSD', '1TB SSD', '2TB SSD'];
      const memoryOptions = ['8GB', '16GB', '32GB', '64GB'];

      return (
        <div className="max-w-7xl mx-auto px-6 py-12">
          <button
            onClick={() => window.location.hash = '#/'}
            className="mb-6 text-gray-600 hover:text-black flex items-center gap-2"
          >
            ← Back to Products
          </button>

          <div className="grid md:grid-cols-2 gap-12">
            {/* Image Gallery */}
            <div>
              <div className="bg-white rounded-2xl overflow-hidden flex items-center justify-center aspect-square mb-4">
                <img
                  src={product.image_url}
                  alt={product.name}
                  className="w-full h-full object-contain"
                  onError={(e) => {
                    e.target.onerror = null;
                    e.target.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 24 24" fill="none" stroke="%23ccc" stroke-width="1"><path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>';
                  }}
                />
              </div>

              {/* Specs Table */}
              <div className="bg-gray-50 rounded-xl p-6">
                <h3 className="text-xl font-bold mb-4">Specifications</h3>
                {product.specs && (
                  <div className="space-y-2 text-sm">
                    {Object.entries(product.specs).map(([key, value]) => (
                      <div key={key} className="flex justify-between py-2 border-b border-gray-200">
                        <span className="capitalize text-gray-600">{key}:</span>
                        <span className="font-semibold">{value}</span>
                      </div>
                    ))}
                    <div className="flex justify-between py-2">
                      <span className="text-gray-600">In Stock:</span>
                      <span className="font-semibold text-green-600">
                        {product.in_stock ? '✓ Available' : '✗ Out of Stock'}
                      </span>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Product Info */}
            <div>
              <h1 className="text-4xl font-bold mb-4">{product.name}</h1>
              <p className="text-gray-600 text-lg mb-6">{product.description}</p>
              <div className="mb-8">
                <p className="text-4xl font-bold">${currentPrice.toLocaleString()}</p>
                {currentPrice !== product.price && (
                  <p className="text-sm text-gray-500 mt-1">
                    Base price: ${product.price.toLocaleString()}
                  </p>
                )}
              </div>

              {/* Configuration Selector */}
              <div className="bg-white border-2 border-gray-200 rounded-xl p-6 mb-6">
                <div className="mb-6">
                  <h3 className="font-semibold mb-3">Storage</h3>
                  <div className="grid grid-cols-2 gap-3">
                    {storageOptions.map(storage => (
                      <button
                        key={storage}
                        onClick={() => setSelectedConfig(prev => ({ ...prev, storage }))}
                        className={`px-4 py-3 rounded-lg border-2 transition-all ${
                          selectedConfig.storage === storage
                            ? 'border-black bg-black text-white'
                            : 'border-gray-200 hover:border-black'
                        }`}
                      >
                        {storage}
                      </button>
                    ))}
                  </div>
                </div>

                <div>
                  <h3 className="font-semibold mb-3">Memory</h3>
                  <div className="grid grid-cols-2 gap-3">
                    {memoryOptions.map(memory => (
                      <button
                        key={memory}
                        onClick={() => setSelectedConfig(prev => ({ ...prev, memory }))}
                        className={`px-4 py-3 rounded-lg border-2 transition-all ${
                          selectedConfig.memory === memory
                            ? 'border-black bg-black text-white'
                            : 'border-gray-200 hover:border-black'
                        }`}
                      >
                        {memory}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              {/* Add to Cart Button */}
              <button
                onClick={handleAddToCart}
                disabled={!product.in_stock}
                className="w-full bg-black text-white px-8 py-4 rounded-full font-semibold text-lg hover:bg-gray-800 transition-all disabled:bg-gray-300 disabled:cursor-not-allowed"
              >
                {product.in_stock ? 'Add to Cart' : 'Out of Stock'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Checkout Page
    function CheckoutPage() {
      const { items, subtotal, tax, total, clearCart } = useContext(CartContext);
      const { isAuthenticated, user, getAuthHeaders } = useContext(AuthContext);
      const [step, setStep] = useState(1); // 1: Shipping, 2: Payment
      const [shippingForm, setShippingForm] = useState({
        name: user?.name || 'John Doe',
        address: '123 Main Street, Apt 4B',
        city: 'New York',
        zip: '10001',
        phone: '+1 (555) 123-4567'
      });
      const [orderId, setOrderId] = useState(null);
      const [paymentAmount, setPaymentAmount] = useState(null);
      const [isProcessing, setIsProcessing] = useState(false);

      useEffect(() => {
        if (!isAuthenticated) {
          if (window.showToast) {
            window.showToast('Please sign in to checkout', 'error');
          }
          window.location.hash = '#/';
        }
        if (items.length === 0) {
          if (window.showToast) {
            window.showToast('Your cart is empty', 'error');
          }
          window.location.hash = '#/';
        }
      }, [isAuthenticated, items]);

      const handleShippingSubmit = async (e) => {
        e.preventDefault();
        setIsProcessing(true);

        try {
          // Create order
          const response = await fetch(`${API_BASE}/api/checkout/create`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...getAuthHeaders()
            },
            body: JSON.stringify({ shippingAddress: shippingForm })
          });

          if (!response.ok) {
            throw new Error('Failed to create order');
          }

          const data = await response.json();
          setOrderId(data.orderId);
          setPaymentAmount(data.amount);
          setStep(2);
        } catch (error) {
          console.error('Error creating order:', error);
          if (window.showToast) {
            window.showToast('Failed to create order. Please try again.', 'error');
          }
        } finally {
          setIsProcessing(false);
        }
      };

      const handlePayment = async (method) => {
        if (!orderId || !paymentAmount) return;

        setIsProcessing(true);

        try {
          const tossPayments = TossPayments(TOSS_CLIENT_KEY);
          await tossPayments.requestPayment(method, {
            amount: paymentAmount,
            orderId: orderId,
            orderName: `${items[0].name}${items.length > 1 ? ` 외 ${items.length - 1}건` : ''}`,
            successUrl: `${window.location.origin}/#/payment/success`,
            failUrl: `${window.location.origin}/#/payment/fail`,
            customerEmail: user?.email || '',
            customerName: shippingForm.name
          });
        } catch (error) {
          console.error('Payment error:', error);
          if (error.code !== 'USER_CANCEL' && window.showToast) {
            window.showToast('Payment failed. Please try again.', 'error');
          }
        } finally {
          setIsProcessing(false);
        }
      };

      return (
        <div className="max-w-7xl mx-auto px-6 py-12">
          <h1 className="text-4xl font-bold mb-8">Checkout</h1>

          <div className="grid md:grid-cols-3 gap-8">
            {/* Main Content */}
            <div className="md:col-span-2">
              {step === 1 ? (
                /* Shipping Form */
                <div className="bg-white rounded-xl p-8 shadow-sm">
                  <h2 className="text-2xl font-bold mb-6">Shipping Address</h2>
                  <form onSubmit={handleShippingSubmit} className="space-y-4">
                    <div>
                      <label className="block text-sm font-semibold mb-2">Full Name</label>
                      <input
                        type="text"
                        required
                        value={shippingForm.name}
                        onChange={(e) => setShippingForm(prev => ({ ...prev, name: e.target.value }))}
                        placeholder="John Doe"
                        className="w-full border border-gray-300 rounded-lg px-4 py-3 focus:border-black focus:ring-2 focus:ring-black focus:ring-opacity-20 outline-none"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold mb-2">Address</label>
                      <input
                        type="text"
                        required
                        value={shippingForm.address}
                        onChange={(e) => setShippingForm(prev => ({ ...prev, address: e.target.value }))}
                        placeholder="123 Main Street, Apt 4B"
                        className="w-full border border-gray-300 rounded-lg px-4 py-3 focus:border-black focus:ring-2 focus:ring-black focus:ring-opacity-20 outline-none"
                      />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-semibold mb-2">City</label>
                        <input
                          type="text"
                          required
                          value={shippingForm.city}
                          onChange={(e) => setShippingForm(prev => ({ ...prev, city: e.target.value }))}
                          placeholder="New York"
                          className="w-full border border-gray-300 rounded-lg px-4 py-3 focus:border-black focus:ring-2 focus:ring-black focus:ring-opacity-20 outline-none"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold mb-2">ZIP Code</label>
                        <input
                          type="text"
                          required
                          value={shippingForm.zip}
                          onChange={(e) => setShippingForm(prev => ({ ...prev, zip: e.target.value }))}
                          placeholder="10001"
                          className="w-full border border-gray-300 rounded-lg px-4 py-3 focus:border-black focus:ring-2 focus:ring-black focus:ring-opacity-20 outline-none"
                        />
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm font-semibold mb-2">Phone</label>
                      <input
                        type="tel"
                        required
                        value={shippingForm.phone}
                        onChange={(e) => setShippingForm(prev => ({ ...prev, phone: e.target.value }))}
                        placeholder="+1 (555) 123-4567"
                        className="w-full border border-gray-300 rounded-lg px-4 py-3 focus:border-black focus:ring-2 focus:ring-black focus:ring-opacity-20 outline-none"
                      />
                    </div>
                    <button
                      type="submit"
                      disabled={isProcessing}
                      className="w-full bg-black text-white px-9 py-5 rounded-full text-lg font-semibold hover:bg-gray-800 transition-all disabled:bg-gray-300"
                    >
                      {isProcessing ? 'Processing...' : 'Continue to Payment →'}
                    </button>
                  </form>
                </div>
              ) : (
                /* Payment */
                <div className="bg-white rounded-xl p-8 shadow-sm">
                  <h2 className="text-2xl font-bold mb-2">Payment</h2>
                  <p className="text-gray-500 mb-6">{paymentAmount ? `Total: ₩${paymentAmount.toLocaleString()} ($${total.toFixed(2)})` : ''}</p>
                  <button
                    onClick={() => handlePayment('카드')}
                    disabled={isProcessing}
                    className="w-full bg-blue-500 text-white px-6 py-5 rounded-full text-lg font-semibold hover:bg-blue-600 transition-all disabled:bg-gray-300"
                  >
                    {isProcessing ? 'Processing...' : 'Pay with Card'}
                  </button>
                </div>
              )}
            </div>

            {/* Order Summary */}
            <div>
              <div className="bg-gray-50 rounded-xl p-6 sticky top-20">
                <h2 className="text-xl font-bold mb-4">Order Summary</h2>
                <div className="space-y-3 mb-4">
                  {items.map(item => (
                    <div key={item.id} className="flex justify-between text-sm">
                      <span>{item.name} x {item.quantity}</span>
                      <span className="font-semibold">${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                  ))}
                </div>
                <div className="border-t border-gray-300 pt-4 space-y-2">
                  <div className="flex justify-between">
                    <span>Subtotal</span>
                    <span>${subtotal.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Tax</span>
                    <span>${tax.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between text-xl font-bold pt-2 border-t border-gray-300">
                    <span>Total</span>
                    <span>${total.toFixed(2)}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Order Confirmation Page
    function OrderConfirmationPage({ orderId }) {
      const { clearCart } = useContext(CartContext);
      const { getAuthHeaders } = useContext(AuthContext);
      const [order, setOrder] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const confirmingRef = useRef(false);

      // Helper to fetch order details
      const fetchOrderDetails = async (oid) => {
        const res = await fetch(`${API_BASE}/api/orders/${oid}`, { headers: getAuthHeaders() });
        const data = await res.json();
        setOrder({ ...data.order, items: data.items });
        setIsLoading(false);
      };

      useEffect(() => {
        // Parse payment success params from URL (Toss puts params in query string before hash)
        const searchParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.split('?')[1]);
        const paymentKey = searchParams.get('paymentKey') || hashParams.get('paymentKey');
        const amount = searchParams.get('amount') || hashParams.get('amount');
        const orderIdFromUrl = searchParams.get('orderId') || hashParams.get('orderId');

        if (paymentKey && orderIdFromUrl && amount) {
          // Payment confirmation flow — guard against duplicate calls
          if (confirmingRef.current) return;
          confirmingRef.current = true;

          fetch(`${API_BASE}/api/payment/toss/confirm`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...getAuthHeaders()
            },
            body: JSON.stringify({
              paymentKey,
              orderId: orderIdFromUrl,
              amount: parseFloat(amount)
            })
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                clearCart();
                return fetchOrderDetails(orderIdFromUrl);
              } else {
                throw new Error(data.error || 'Payment confirmation failed');
              }
            })
            .catch(async (error) => {
              console.error('Confirm error, fetching order anyway:', error);
              try {
                await fetchOrderDetails(orderIdFromUrl);
              } catch (e) {
                console.error('Error fetching order:', e);
                setIsLoading(false);
              }
            });
        } else if (orderId) {
          // Direct order view from order history — just fetch details
          fetchOrderDetails(orderId).catch(() => setIsLoading(false));
        } else {
          setIsLoading(false);
        }
      }, [orderId]);

      if (isLoading) {
        return (
          <div className="flex justify-center py-20">
            <div className="spinner"></div>
          </div>
        );
      }

      if (!order) {
        return (
          <div className="max-w-7xl mx-auto px-6 py-20 text-center">
            <h2 className="text-3xl font-bold mb-4">Order Not Found</h2>
            <button
              onClick={() => window.location.hash = '#/'}
              className="bg-black text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-800"
            >
              Back to Products
            </button>
          </div>
        );
      }

      return (
        <div className="max-w-3xl mx-auto px-6 py-12">
          <div className="text-center mb-12">
            <div className="w-20 h-20 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <h1 className="text-4xl font-bold mb-2">Order Confirmed!</h1>
            <p className="text-xl text-gray-600">Thank you for your purchase</p>
            <p className="text-lg text-gray-500 font-mono mt-2">Order #{order.id.slice(0, 8).toUpperCase()}</p>
          </div>

          <div className="bg-white rounded-xl shadow-lg p-8 mb-8">
            <h2 className="text-2xl font-bold mb-6">Order Details</h2>

            {/* Order Items */}
            <div className="space-y-3 mb-6 pb-6 border-b border-gray-200">
              {order.items && order.items.map(item => (
                <div key={item.id} className="flex justify-between">
                  <span>{item.product_name} x {item.quantity}</span>
                  <span className="font-semibold">${(parseFloat(item.unit_price) * item.quantity).toFixed(2)}</span>
                </div>
              ))}
            </div>

            {/* Totals */}
            <div className="space-y-2 mb-6 pb-6 border-b border-gray-200">
              <div className="flex justify-between">
                <span>Subtotal</span>
                <span>${parseFloat(order.subtotal).toFixed(2)}</span>
              </div>
              <div className="flex justify-between">
                <span>Tax</span>
                <span>${parseFloat(order.tax).toFixed(2)}</span>
              </div>
              <div className="flex justify-between text-xl font-bold">
                <span>Total</span>
                <span>${parseFloat(order.total_amount).toFixed(2)}</span>
              </div>
            </div>

            {/* Shipping Address */}
            <div>
              <h3 className="font-bold mb-2">Shipping Address</h3>
              {order.shipping_address && (
                <p className="text-gray-600">
                  {order.shipping_address.name}<br />
                  {order.shipping_address.address}<br />
                  {order.shipping_address.city}, {order.shipping_address.zip}<br />
                  {order.shipping_address.phone}
                </p>
              )}
            </div>
          </div>

          <div className="text-center">
            <button
              onClick={() => window.location.hash = '#/'}
              className="bg-black text-white px-8 py-3 rounded-full font-semibold hover:bg-gray-800 transition-all"
            >
              Continue Shopping
            </button>
          </div>
        </div>
      );
    }

    // Order History Page
    function OrderHistoryPage() {
      const { isAuthenticated, getAuthHeaders } = useContext(AuthContext);
      const [orders, setOrders] = useState([]);
      const [isLoading, setIsLoading] = useState(true);

      useEffect(() => {
        if (!isAuthenticated) {
          window.location.hash = '#/';
          return;
        }
        fetch(`${API_BASE}/api/orders`, { headers: getAuthHeaders() })
          .then(res => res.json())
          .then(data => {
            setOrders(data.orders || []);
            setIsLoading(false);
          })
          .catch(() => setIsLoading(false));
      }, []);

      if (isLoading) {
        return (
          <div className="flex justify-center py-20">
            <div className="spinner"></div>
          </div>
        );
      }

      return (
        <div className="max-w-4xl mx-auto px-6 py-12">
          <h1 className="text-4xl font-bold mb-8">Order History</h1>

          {orders.length === 0 ? (
            <div className="text-center py-16">
              <svg className="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
              </svg>
              <p className="text-xl text-gray-500 mb-6">No orders yet</p>
              <button
                onClick={() => window.location.hash = '#/'}
                className="bg-black text-white px-6 py-3 rounded-full font-semibold hover:bg-gray-800 transition-all"
              >
                Start Shopping
              </button>
            </div>
          ) : (
            <div className="space-y-4">
              {orders.map(order => {
                const statusColors = {
                  paid: 'bg-green-100 text-green-700',
                  pending: 'bg-yellow-100 text-yellow-700',
                  failed: 'bg-red-100 text-red-700',
                  cancelled: 'bg-gray-100 text-gray-700',
                  refunded: 'bg-purple-100 text-purple-700'
                };
                return (
                  <div
                    key={order.id}
                    className="bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow cursor-pointer"
                    onClick={() => window.location.hash = `#/order/${order.id}`}
                  >
                    <div className="flex justify-between items-start mb-3">
                      <div>
                        <p className="font-mono text-sm text-gray-500">#{order.id.slice(0, 8).toUpperCase()}</p>
                        <p className="text-sm text-gray-500 mt-1">
                          {new Date(order.created_at).toLocaleDateString('en-US', {
                            year: 'numeric', month: 'long', day: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                          })}
                        </p>
                      </div>
                      <span className={`px-3 py-1 rounded-full text-sm font-semibold ${statusColors[order.status] || 'bg-gray-100 text-gray-700'}`}>
                        {order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                      </span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-2xl font-bold">${parseFloat(order.total_amount).toFixed(2)}</span>
                      <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                      </svg>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    }

    // Router Component (Hash-based routing)
    function Router() {
      const [currentRoute, setCurrentRoute] = useState(window.location.hash || '#/');

      useEffect(() => {
        const handleHashChange = () => {
          setCurrentRoute(window.location.hash || '#/');
        };

        window.addEventListener('hashchange', handleHashChange);
        return () => window.removeEventListener('hashchange', handleHashChange);
      }, []);

      // Parse route and params
      const parseRoute = (hash) => {
        if (!hash || hash === '#/' || hash === '#') {
          return { page: 'home', params: {} };
        }

        const cleanHash = hash.replace('#/', '').split('?')[0];
        const parts = cleanHash.split('/');

        if (parts[0] === 'product' && parts[1]) {
          return { page: 'product', params: { productId: parts[1] } };
        }

        if (parts[0] === 'checkout') {
          return { page: 'checkout', params: {} };
        }

        if (parts[0] === 'orders') {
          return { page: 'orders', params: {} };
        }

        if (parts[0] === 'order' && parts[1]) {
          return { page: 'order', params: { orderId: parts[1] } };
        }

        if (parts[0] === 'payment' && parts[1] === 'success') {
          return { page: 'payment-success', params: {} };
        }

        if (parts[0] === 'payment' && parts[1] === 'fail') {
          return { page: 'payment-fail', params: {} };
        }

        return { page: 'home', params: {} };
      };

      const route = parseRoute(currentRoute);

      // Render appropriate page
      switch (route.page) {
        case 'product':
          return <ProductDetailPage productId={route.params.productId} />;
        case 'checkout':
          return <CheckoutPage />;
        case 'orders':
          return <OrderHistoryPage />;
        case 'order':
          return <OrderConfirmationPage orderId={route.params.orderId} />;
        case 'payment-success':
          return <OrderConfirmationPage />;
        case 'payment-fail':
          return (
            <div className="max-w-7xl mx-auto px-6 py-20 text-center">
              <h2 className="text-3xl font-bold mb-4 text-red-600">Payment Failed</h2>
              <p className="text-xl text-gray-600 mb-8">Your payment could not be processed. Please try again.</p>
              <button
                onClick={() => window.location.hash = '#/checkout'}
                className="bg-black text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-800"
              >
                Try Again
              </button>
            </div>
          );
        case 'home':
        default:
          return <HomePage />;
      }
    }

    // Main App
    function App() {
      return (
        <AuthProvider>
          <CartProvider>
            <div className="min-h-screen bg-gray-50">
              <Navigation />
              <Router />
              <CartSidebar />
              <ToastContainer />
            </div>
          </CartProvider>
        </AuthProvider>
      );
    }

    // Render app
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
